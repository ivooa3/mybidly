generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Shop {
  id                       String       @id @default(cuid())
  email                    String       @unique
  passwordHash             String       @map("password_hash")
  shopName                 String?      @map("shop_name")
  createdAt                DateTime     @default(now()) @map("created_at")
  updatedAt                DateTime     @updatedAt @map("updated_at")
  businessAddress          Json?        @map("business_address")
  firstName                String?      @map("first_name")
  lastName                 String?      @map("last_name")
  orderEmail               String?      @map("order_email")
  shopUrl                  String?      @map("shop_url")
  stripeAccountId          String?      @unique @map("stripe_account_id")
  stripeAccountStatus      String?      @default("pending") @map("stripe_account_status")
  stripeOnboardingComplete Boolean      @default(false) @map("stripe_onboarding_complete")
  vatNumber                String?      @map("vat_number")
  platformFeeEnabled       Boolean      @default(true) @map("platform_fee_enabled")
  platformFeePercentage    Decimal      @default(8.0) @map("platform_fee_percentage") @db.Decimal(5, 2)
  deactivatedAt            DateTime?    @map("deactivated_at")
  isActive                 Boolean      @default(true) @map("is_active")
  planTier                 String       @default("payg") @map("plan_tier") // 'payg' or 'premium'
  role                     String       @default("shop_owner")
  preferredLanguage        String       @default("en") @map("preferred_language")
  resetToken               String?      @map("reset_token")
  resetTokenExpiresAt      DateTime?    @map("reset_token_expires_at")
  trialEndsAt              DateTime?    @map("trial_ends_at")
  trialEndedByFirstOrder   Boolean      @default(false) @map("trial_ended_by_first_order")
  bids                     Bid[]
  offers                   Offer[]
  widgetViews              WidgetView[]

  @@map("shops")
}

model Offer {
  id               String   @id @default(cuid())
  shopId           String   @map("shop_id")
  productName      String   @map("product_name")
  productSku       String   @map("product_sku")
  imageUrl         String   @map("image_url")
  stockQuantity    Int      @map("stock_quantity")
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")
  minPrice         Decimal  @map("min_price") @db.Decimal(10, 2)
  scopeOfDelivery  String?  @map("scope_of_delivery")
  priority         Int      @default(999)
  minRange         Int      @default(-10) @map("min_range")
  maxRange         Int      @default(25) @map("max_range")
  offerHeadline    String?  @map("offer_headline")
  offerSubheadline String?  @map("offer_subheadline")
  fixPrice         Decimal  @default(24.60) @map("fix_price") @db.Decimal(10, 2)
  bids             Bid[]
  shop             Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopId, priority])
  @@unique([shopId, productSku])
  @@index([shopId])
  @@index([priority])
  @@map("offers")
}

model Bid {
  id                    String    @id @default(cuid())
  shopId                String    @map("shop_id")
  offerId               String    @map("offer_id")
  customerEmail         String    @map("customer_email")
  customerName          String    @map("customer_name")
  shippingAddress       Json      @map("shipping_address")
  bidAmount             Decimal   @map("bid_amount") @db.Decimal(10, 2)
  status                String
  stripePaymentId       String    @unique @map("stripe_payment_id")
  locale                String
  acceptanceEmailSentAt DateTime? @map("acceptance_email_sent_at")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  isFixPrice            Boolean   @default(false) @map("is_fix_price")
  platformFeeAmount     Decimal?  @map("platform_fee_amount") @db.Decimal(10, 2)
  shopOwnerAmount       Decimal?  @map("shop_owner_amount") @db.Decimal(10, 2)
  stripeTransferId      String?   @map("stripe_transfer_id")
  offer                 Offer     @relation(fields: [offerId], references: [id], onDelete: Cascade)
  shop                  Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([offerId])
  @@index([status])
  @@index([createdAt])
  @@map("bids")
}

model WidgetView {
  id        String   @id @default(cuid())
  shopId    String   @map("shop_id")
  offerId   String?  @map("offer_id")
  productId String?  @map("product_id")
  visitorId String?  @map("visitor_id")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  referer   String?
  didBid    Boolean  @default(false) @map("did_bid")
  viewType  String   @default("shown") @map("view_type") // "shown", "limit_reached", "no_offers", "out_of_stock"
  createdAt DateTime @default(now()) @map("created_at")
  shop      Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([offerId])
  @@index([createdAt])
  @@index([visitorId])
  @@index([viewType])
  @@map("widget_views")
}
